@page "/Leaderboard"
@using AGC_Management.Utils
@using AGC_Management.Entities.Web
@using AGC_Management.Entities
@attribute [Authorize (Roles = "BotOwner, Administrator, Moderator, Supporter, Team, User")]
@inject IHttpContextAccessor HttpContextAccessor

@if (LevelUtils.LeaderboardDataLoaded)
{
    <div class="leaderboard-container">
        <h3>Leaderboard</h3>
        <div class="leaderboard">
            @foreach (var item in currentPageData)
            {
                <div class="leaderboard-item @(IsCurrentUser(item.UserId) ? "you" : "")">
                    <div class="rank">
                        <span class="rank-number">@item.Rank</span>
                    </div>
                    <div class="avatar">
                        <img src="@item.Avatar" alt="@item.Username" />
                    </div>
                    <div class="username">@item.Username</div>
                    <div class="level-container">
                        <div class="level">Level @item.Level</div>
                    </div>
                    <div class="experience">@item.Experience XP</div>
                </div>
            }
        </div>
        <div class="pagination-lg">
            <div class="page-info">Seite @currentPage von @totalPages</div>
            <button class="btn btn-primary" @onclick="PreviousPage" disabled="@IsFirstPage">Vorherige Seite</button>
            <button class="btn btn-primary" @onclick="NextPage" disabled="@IsLastPage">Nächste Seite</button>
        </div>
    </div>
}
else
{
    <em class="alert alert-danger">Das Leaderboard wird gerade geladen. Bitte warten...</em>
}




@code {
    
    private List<WebLeaderboardData> leaderboardData = new List<WebLeaderboardData>();
    private List<WebLeaderboardData> currentPageData = new List<WebLeaderboardData>();
    private const int ItemsPerPage = 25;
    private int currentPage = 1;
    private int totalItems;
    private int totalPages => (int)Math.Ceiling((double)totalItems / ItemsPerPage);

    
    protected override async Task OnInitializedAsync()
    {
        await LoadLeaderboardData();
    }
    
    private async Task LoadLeaderboardData()
    {
        var leaderboard = LevelUtils._leaderboardData;
        totalItems = leaderboard.Count;
        var tasks = leaderboard.Select(async (x, i) =>
        {
            var isOnServer = await IsUserOnServer(x.UserId);
            var isCached = await IsUserInCache(x.UserId);
            string avatarUrl, username;

            if (isOnServer)
            {
                var user = await CurrentApplication.DiscordClient.GetUserAsync(x.UserId);
                avatarUrl = user.AvatarUrl;
                username = user.Username;
            }
            else if (isCached)
            {
                var user = CurrentApplication.DiscordClient.UserCache[x.UserId];
                avatarUrl = user.AvatarUrl;
                username = user.Username;
            } 
            else
            {
                var fallbackUser = GetFallbackUser(x.UserId);
                avatarUrl = fallbackUser.Avatar;
                username = fallbackUser.UserName;
            }

            return new WebLeaderboardData
            {
                Avatar = avatarUrl,
                UserId = x.UserId,
                Username = username,
                Level = x.Level,
                Experience = x.Experience,
                Rank = i + 1,
                ProgressInPercent = x.ProgressInPercent,
            };
        });

        leaderboardData = (await Task.WhenAll(tasks)).ToList();
        await LoadPage(currentPage);
    }
    
    private async Task LoadPage(int page)
    {
        var start = (page - 1) * ItemsPerPage;
        var count = Math.Min(ItemsPerPage, leaderboardData.Count - start);
        currentPageData = leaderboardData.GetRange(start, count); // Aktualisieren Sie nur die currentPageData Liste
    }
    private async Task NextPage()
    {
        if (!IsLastPage)
        {
            currentPage++;
            await LoadPage(currentPage);
        }
    }

    private async Task PreviousPage()
    {
        if (!IsFirstPage)
        {
            currentPage--;
            await LoadPage(currentPage);
        }
    }
    
    private bool IsFirstPage => currentPage == 1;
    private bool IsLastPage => currentPage * ItemsPerPage >= totalItems;
    
    private bool IsCurrentUser(ulong userId)
    {
        return userId == ToolSet.GetUserIdFromHttpContext(HttpContextAccessor.HttpContext);
    }

    
    private async Task<bool> IsUserOnServer(ulong userId)
    {
        try
        {
            var serverMembers = CurrentApplication.TargetGuild.Members.Values.ToList();
            
            return serverMembers.Any(member => member.Id == userId);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Fehler beim Abrufen der Servermitglieder: " + ex.Message);
            return false;
        }
    }
    
    private async Task<bool> IsUserInCache(ulong userId)
    {
        try
        {
            var cachedmembers = CurrentApplication.DiscordClient.UserCache.Values.ToList();
            
            return cachedmembers.Any(member => member.Id == userId);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Fehler beim Abrufen der Servermitglieder: " + ex.Message);
            return false;
        }
    }
    
    private PartialUser GetFallbackUser(ulong userId)
    {
        return new PartialUser
        {
            UserId = userId,
            UserName = userId.ToString(),
            Avatar = "https://cdn.discordapp.com/embed/avatars/0.png"
        };
    }
    
    
}