@page "/Leaderboard"
@using AGC_Management.Utils
@using AGC_Management.Entities.Web
@using AGC_Management.Entities
@attribute [Authorize (Roles = "BotOwner, Administrator, Moderator, Supporter, Team, User")]
@inject IHttpContextAccessor HttpContextAccessor

@if (LevelUtils.LeaderboardDataLoaded)
{
    <div class="leaderboard-container">
        <h3>Leaderboard</h3>
        <div class="leaderboard">
            @foreach (var item in currentPageData)
            {
                <div class="leaderboard-item @(IsCurrentUser(item.UserId) ? "you" : "")">
                    <div class="rank">
                        <span class="rank-number">@item.Rank</span>
                    </div>
                    <div class="avatar">
                        <img src="@item.Avatar" alt="@item.Username" />
                    </div>
                    <div class="username">@item.Username</div>
                    <div class="level-container">
                        <div class="level">Level @item.Level</div>
                    </div>
                    <div class="experience">@item.Experience XP</div>
                </div>
            }
        </div>
        <div class="pagination-lg">
            <div class="page-info">Seite @currentPage von @totalPages</div>
            <button class="btn btn-primary" @onclick="PreviousPage" disabled="@IsFirstPage">Vorherige Seite</button>
            <button class="btn btn-primary" @onclick="NextPage" disabled="@IsLastPage">Nächste Seite</button>
        </div>
    </div>
}
else
{
    <em class="alert alert-danger">Das Leaderboard wird gerade geladen. Bitte warten...</em>
}




@code {
    
    private List<WebLeaderboardData> currentPageData = new List<WebLeaderboardData>();
    private const int ItemsPerPage = 25;
    private int currentPage = 1;
    private int totalItems;
    private int totalPages => (int)Math.Ceiling((double)totalItems / ItemsPerPage);

    
    protected override async Task OnInitializedAsync()
    {
        await LoadPage(currentPage);
    }
    private async Task LoadPage(int page)
    {
        var start = (page - 1) * ItemsPerPage;
        totalItems = LevelUtils.cachedLeaderboardData.Count;
        var count = Math.Min(ItemsPerPage, LevelUtils.cachedLeaderboardData.Count - start);
        currentPageData = LevelUtils.cachedLeaderboardData.GetRange(start, count);
    }
    private async Task NextPage()
    {
        if (!IsLastPage)
        {
            currentPage++;
            await LoadPage(currentPage);
        }
    }

    private async Task PreviousPage()
    {
        if (!IsFirstPage)
        {
            currentPage--;
            await LoadPage(currentPage);
        }
    }
    
    private bool IsFirstPage => currentPage == 1;
    private bool IsLastPage => currentPage * ItemsPerPage >= totalItems;
    
    private bool IsCurrentUser(ulong userId)
    {
        return userId == ToolSet.GetUserIdFromHttpContext(HttpContextAccessor.HttpContext);
    }

    

    
}